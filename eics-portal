# eics_lms/settings.py (snippet for setup)

INSTALLED_APPS = [
    ...
    'core',
    'crispy_forms',
]

CRISPY_TEMPLATE_PACK = 'bootstrap4'

STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / 'static']

# M-PESA Paybill Info
MPESA_PAYBILL = '4080793'
MPESA_ACCOUNT_FORMAT = 'Admission Number'

# ---

# core/models.py
from django.db import models

class Student(models.Model):
    full_name = models.CharField(max_length=100)
    admission_number = models.CharField(max_length=20, unique=True)
    email = models.EmailField()

    def __str__(self):
        return f"{self.full_name} ({self.admission_number})"

class Payment(models.Model):
    student = models.ForeignKey(Student, on_delete=models.CASCADE)
    amount = models.DecimalField(max_digits=8, decimal_places=2)
    transaction_id = models.CharField(max_length=100)
    timestamp = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.student} - {self.transaction_id}"

# ---

# core/forms.py
from django import forms
from .models import Student

class PaymentForm(forms.Form):
    admission_number = forms.CharField(label="Admission Number")
    amount = forms.DecimalField(label="Amount (KES)", max_digits=8, decimal_places=2)

# ---

# core/views.py
from django.shortcuts import render, get_object_or_404
from django.conf import settings
from .forms import PaymentForm
from .models import Student, Payment
import uuid


def payment_view(request):
    message = ''
    if request.method == 'POST':
        form = PaymentForm(request.POST)
        if form.is_valid():
            adm = form.cleaned_data['admission_number']
            amount = form.cleaned_data['amount']
            student = get_object_or_404(Student, admission_number=adm)
            transaction_id = f"EICS-{uuid.uuid4().hex[:8]}"

            Payment.objects.create(
                student=student,
                amount=amount,
                transaction_id=transaction_id
            )

            message = f"Payment request for KES {amount} received for {student.full_name}. Transaction ID: {transaction_id}"

            # (Future: Initiate M-PESA STK push here)

    else:
        form = PaymentForm()

    return render(request, 'core/payment.html', {'form': form, 'message': message})

# ---

# core/templates/core/payment.html
<!DOCTYPE html>
<html>
<head>
    <title>Pay with M-PESA</title>
</head>
<body>
    <h2>Pay Fees via M-PESA</h2>
    {% if message %}<p style="color:green;">{{ message }}</p>{% endif %}
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Submit Payment</button>
    </form>
    <p><strong>Paybill:</strong> 4080793<br>
       <strong>Account:</strong> Your Admission Number</p>
</body>
</html>

# ---

# eics_lms/urls.py
from django.contrib import admin
from django.urls import path
from core.views import payment_view

urlpatterns = [
    path('admin/', admin.site.urls),
    path('pay/', payment_view, name='payment'),
]

# ---

# To Run:
# python manage.py makemigrations && python manage.py migrate
# python manage.py createsuperuser
# python manage.py runserver

